<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script type="module">
        import { auth } from "./firebase-config.js";
        (() => {
            auth.onAuthStateChanged(user => {
                const hash = window.location.hash;
                if (!user && hash.startsWith('#/dashboard')) window.location.hash = '#/';
            });
        })();
    </script>

    <title>세무정석 v1046 - 유튜버 종합소득세 AI 장부</title>
    <!-- Use both CSS files to be safe, as they seem to contain critical premium styles -->
    <link rel="stylesheet" href="CODA_Refund_Style.css?v=1046">
    <link rel="stylesheet" href="SeomuFix.css?v=1046">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://service.iamport.kr/js/iamport.payment-1.1.8.js"></script>
</head>

<body>
    <div class="bg-decor">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="version-tag">Koda Engine v1046 Alpha</div>
        <div class="blob blob-3"></div>
    </div>

    <!-- 1. Landing View -->
    <div id="user-type-overlay" class="welcome-overlay">
        <div class="welcome-card">
            <div class="welcome-header">
                <div class="welcome-emoji">🤖</div>
                <h1 class="welcome-title">세무정석 AI</h1>
                <p class="welcome-description">유튜버를 위한 가장 똑똑한 세금 관리</p>
            </div>

            <div id="login-form-area">
                <form onsubmit="kodaEngine.login(event)" style="display:flex; flex-direction:column; gap:1.2rem;">
                    <input type="text" id="login-id" placeholder="아이디 (또는 이메일)" required
                        style="padding:1.2rem; border-radius:15px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:white;">
                    <input type="password" id="login-pw" placeholder="비밀번호" required
                        style="padding:1.2rem; border-radius:15px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:white;">
                    <button type="submit" class="btn-primary"
                        style="padding:1.2rem; font-weight:800; border-radius:15px;">시작하기</button>
                    <button type="button" class="btn-secondary" onclick="kodaEngine.loginWithGoogle()"
                        style="display:flex; align-items:center; justify-content:center; gap:0.5rem; padding:1.2rem; border-radius:15px;">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/layout/google.svg" width="18">
                        구글로 계속하기
                    </button>
                </form>
                <div class="welcome-footer">
                    <p style="font-size:0.9rem; color:var(--text-muted);">
                        계정이 없으신가요? <a href="#" onclick="get('payment-modal').style.display='flex'"
                            style="color:var(--accent); font-weight:700;">가입하기</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Main Dashboard -->
    <div id="app-container" class="app-container" style="display:none;">
        <div style="position:fixed; top:5px; right:5px; font-size:10px; color:rgba(255,255,255,0.1); z-index:10000;">
            v1046</div>

        <header class="main-header">
            <div class="logo-area">
                <h1 style="font-size:1.4rem; line-height:1.2;">유튜버<br>종합소득세 신고앱</h1>
            </div>
            <div id="user-status-indicator" style="text-align:right;">
                <div style="font-size:0.9rem; font-weight:700;"><span id="logged-in-user-id">User</span>님</div>
                <a href="#" onclick="kodaEngine.logout()" style="font-size:0.8rem; color:var(--text-muted);">로그아웃</a>
            </div>
        </header>

        <section class="summary-section"
            style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:2rem;">
            <div class="glass-card stat-card dark" onclick="kodaEngine.showPrevYearSummary()"
                style="cursor:pointer; position:relative; overflow:hidden;">
                <label style="opacity:0.7; font-size:0.8rem;">전년도 실적</label>
                <div class="value" style="font-size:1.1rem; font-weight:800; margin:5px 0;">AI 요약/입력</div>
                <div class="tag blue"
                    style="background:var(--accent); color:white; font-size:0.7rem; padding:2px 8px; border-radius:20px; display:inline-block;">
                    종소세용</div>
            </div>
            <div class="glass-card stat-card active" onclick="kodaEngine.showYearlyCategorySummary()"
                style="cursor:pointer; background:rgba(59,130,246,0.1); border:1px solid rgba(59,130,246,0.2);">
                <label style="opacity:0.7; font-size:0.8rem;">2025년 실적</label>
                <div class="value" style="font-size:1.1rem; font-weight:800; margin:5px 0;">항목별 리포트</div>
                <div class="tag green"
                    style="background:var(--success); color:white; font-size:0.7rem; padding:2px 8px; border-radius:20px; display:inline-block;">
                    실시간</div>
            </div>
        </section>

        <section class="records-list-container">
            <div class="section-header"
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 class="title">최근 기록</h3>
                <button class="btn-text" onclick="kodaEngine.showYearlyCategorySummary()"
                    style="background:none; border:none; color:var(--accent); font-size:0.9rem; cursor:pointer;">전체보기
                    ›</button>
            </div>
            <div class="glass-card" style="padding:0; border-radius:20px; overflow:hidden;">
                <table class="records-table">
                    <tbody id="history-list-mvp">
                        <!-- records injected here -->
                    </tbody>
                </table>
            </div>
        </section>

        <div class="mvp-mic-anchor">
            <div class="pulsing-mic-bg"></div>
            <button class="btn-giant-mic" onclick="kodaEngine.startVoiceRecord()">🎙️</button>
            <div class="mic-label">말해서 기록하기</div>
            <div class="mic-hint">"광고비 22번, 500만원"</div>
        </div>

        <section style="margin-top:2rem; opacity:0.6;">
            <div class="glass-card" style="padding:1.2rem; border-radius:20px; font-size:0.85rem;">
                <div style="display:flex; align-items:center; gap:10px; color:var(--accent);">
                    <span>📢</span>
                    <span>AI 요약 기반 간편 입력 모드 (v1046)</span>
                </div>
            </div>
        </section>

        <div style="margin-top:25px; text-align:center; opacity:0.2; font-size:10px; cursor:pointer; padding-bottom:50px;"
            onclick="location.reload(true)">시스템 강제 새로고침 (v1046)</div>
    </div>

    <!-- AI 요약 가이드 모달 (v1046 필수) -->
    <div id="bulk-modal" class="modal-overlay"
        style="display:none; z-index:999999 !important; background:rgba(0,0,0,0.9); backdrop-filter:blur(10px);">
        <div class="welcome-card" style="max-width:500px; padding:2.5rem; text-align:left;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                <h2 style="font-size:1.4rem; font-weight:900;">AI 요약 및 간편 입력</h2>
                <button class="btn-icon" onclick="get('bulk-modal').style.display='none'">✕</button>
            </div>

            <div id="bulk-input-area">
                <div class="bg-card-alt"
                    style="background:rgba(255,255,255,0.03); padding:1.5rem; border-radius:24px; margin-bottom:1.5rem;">
                    <p class="guide-steps" style="margin-bottom:20px;">
                        1. 아래 버튼으로 <b>AI 프롬프트</b>를 복사하세요.<br>
                        2. AI(ChatGPT/Gemini)에게 카드 내역 요약을 시키세요.<br>
                        3. 합계에서 <b>개인 지출을 뺀 최종 금액</b>을 음성으로 말씀하세요.
                    </p>
                    <button onclick="kodaEngine.copyGeminiPrompt()" class="btn-primary"
                        style="width:100%; padding:1.2rem; border-radius:18px; font-weight:800;">
                        📋 AI 요약 프롬프트 복사
                    </button>
                </div>

                <div
                    style="background:rgba(239,68,68,0.1); padding:1.2rem; border-radius:20px; border:1px solid rgba(239,68,68,0.2); color:#f87171; font-size:0.8rem; margin-bottom:2rem; line-height:1.5;">
                    ⚠️ <b>주의</b>: 식대, 사적 모임 등 업무 무관 지출은 본인이 직접 제외해야 합니다. 세무상 책임은 사용자 본인에게 있습니다.
                </div>

                <div style="text-align:center;">
                    <button class="btn-giant-mic" onclick="kodaEngine.startVoiceRecord()"
                        style="width:100px; height:100px; margin:0 auto;">🎙️</button>
                    <p style="margin-top:1rem; font-size:0.9rem; font-weight:600;">지금 바로 말씀하세요</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 음성 입력 모달 -->
    <div id="voice-modal" class="modal-overlay"
        style="display:none; z-index:1000000 !important; background:rgba(0,0,0,0.95);">
        <div class="welcome-card" style="max-width:400px; padding:3rem;">
            <div class="voice-wave">
                <span></span><span></span><span></span><span></span>
            </div>
            <p id="voice-status-text" style="font-weight:800; font-size:1.2rem; margin-bottom:1.5rem;">듣고 있습니다...</p>
            <div id="voice-transcribed-text" class="voice-result-box"
                style="font-size:1.1rem; color:var(--accent); min-height:60px;">...</div>

            <div id="voice-result-box-confirm" style="display:none; width:100%; margin-top:2rem;">
                <button class="btn-primary" onclick="kodaEngine.confirmVoiceEntry()"
                    style="width:100%; padding:1.2rem; border-radius:15px; font-weight:800;">장부에 기록하기</button>
            </div>
            <button class="btn-text-link" onclick="get('voice-modal').style.display='none'"
                style="margin-top:1.5rem;">닫기</button>
        </div>
    </div>

    <!-- 리포트 모달 -->
    <div id="report-modal" class="modal-overlay"
        style="display:none; z-index:999998 !important; background:rgba(0,0,0,0.9);">
        <div class="welcome-card" style="max-width:460px; padding:2.5rem; text-align:left;">
            <h2 id="report-title" class="section-header title" style="margin-bottom:2rem;">세분화 분석 리포트</h2>
            <div id="report-content" class="report-box" style="max-height: 50vh; overflow-y: auto;"></div>
            <button class="btn-primary" onclick="kodaEngine.closeReportModal()"
                style="width:100%; padding:1.2rem; border-radius:18px; margin-top:2rem;">확인</button>
        </div>
    </div>

    <!-- 결제 모달 -->
    <div id="payment-modal" class="modal-overlay" style="display:none; z-index:1000001;">
        <div class="welcome-card" style="max-width:400px; padding:3rem;">
            <div id="payment-view-initial">
                <div class="welcome-emoji">💎</div>
                <h3 style="font-size:1.5rem; font-weight:900; margin-bottom:1.5rem;">프리미엄 멤버십</h3>
                <div class="price-card">
                    <div class="price-amount">5,900원</div>
                    <div class="price-tagline">1년 무제한 이용</div>
                </div>
                <button onclick="kodaEngine.requestKakaoPay()" class="btn-primary"
                    style="width:100%; padding:1.2rem; background:#FFEB00; color:#3C1E1E; border:none; font-weight:800; border-radius:15px;">카카오페이
                    결제</button>
            </div>
            <button class="modal-close" onclick="get('payment-modal').style.display='none'">✕</button>
        </div>
    </div>

    <!-- Toast UI & Footer -->
    <div id="app-toast"></div>
    <script type="module" src="index_v1046.js?v=1046_final"></script>
</body>

</html>