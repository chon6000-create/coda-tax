<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script type="module">
        import { auth } from "./firebase-config.js";
        (() => {
            auth.onAuthStateChanged(user => {
                const hash = window.location.hash;
                if (!user && hash.startsWith('#/dashboard')) window.location.hash = '#/';
            });
        })();
    </script>

    <title>세무정석 v1046 - 유튜버 종합소득세 AI 장부</title>
    <link rel="stylesheet" href="CODA_Refund_Style.css?v=1046">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://service.iamport.kr/js/iamport.payment-1.1.8.js"></script>
</head>

<body>
    <div class="bg-decor">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="version-tag">Koda Engine v1046 Alpha</div>
        <div class="blob blob-3"></div>
    </div>

    <!-- 1. Landing View -->
    <div id="user-type-overlay" class="overlay">
        <div class="glass-card login-card" style="text-align:center;">
            <div style="margin-bottom:2rem;">
                <h1 style="font-size:1.8rem; font-weight:900; color:var(--text-primary); margin-bottom:0.5rem;">세무정석 AI
                </h1>
                <p style="color:var(--text-muted); font-size:0.9rem;">유튜버를 위한 가장 똑똑한 세금 관리</p>
            </div>

            <div id="login-form-area">
                <form onsubmit="kodaEngine.login(event)" style="display:flex; flex-direction:column; gap:1rem;">
                    <input type="text" id="login-id" placeholder="아이디 (또는 이메일)" required>
                    <input type="password" id="login-pw" placeholder="비밀번호" required>
                    <button type="submit" class="btn-primary" style="padding:1.2rem; font-weight:700;">시작하기</button>
                    <button type="button" class="btn-secondary" onclick="kodaEngine.loginWithGoogle()"
                        style="display:flex; align-items:center; justify-content:center; gap:0.5rem;">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/layout/google.svg" width="18">
                        구글로 계속하기
                    </button>
                </form>
                <p style="margin-top:1.5rem; font-size:0.85rem; color:var(--text-muted);">
                    계정이 없으신가요? <a href="#" onclick="kodaEngine.tryStartService()"
                        style="color:var(--primary); font-weight:700;">가입하기</a>
                </p>
            </div>
        </div>
    </div>

    <!-- 2. Main Dashboard -->
    <div id="app-container" class="app-container" style="display:none; padding: 20px; padding-bottom: 60px;">
        <div style="position:fixed; top:5px; right:5px; font-size:10px; color:rgba(255,255,255,0.1); z-index:10000;">
            v1046</div>
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h1 style="font-size:1.2rem; font-weight:900; line-height:1.2;">유튜버<br>종합소득세 신고앱</h1>
            <div id="user-status-indicator" style="font-size:0.8rem; color:var(--text-muted);">
                <span id="logged-in-user-id">User</span>님 | <a href="#" onclick="kodaEngine.logout()"
                    style="color:var(--text-muted);">로그아웃</a>
            </div>
        </header>

        <section class="summary-section">
            <div class="glass-card stat-card dark" onclick="kodaEngine.showPrevYearSummary()">
                <label>전년도 실적 (종소세용)</label>
                <div class="value">AI 요약/입력</div>
                <div class="tag blue">신고전용</div>
            </div>
            <div class="glass-card stat-card active" onclick="kodaEngine.showYearlyCategorySummary()">
                <label>2025년 현재 실적</label>
                <div class="value">항목별 리포트</div>
                <div class="tag green">실시간</div>
            </div>
        </section>

        <section style="margin-top:2rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="font-size:1rem; font-weight:700;">최근 기록</h3>
                <button class="btn-text" onclick="kodaEngine.openAddModal()">내역 전체보기 ›</button>
            </div>
            <div class="glass-card" style="padding:0; overflow:hidden;">
                <table class="data-table">
                    <tbody id="history-list-mvp"></tbody>
                </table>
            </div>
        </section>

        <section style="margin-top:2rem;">
            <h3 style="margin-bottom:1rem; font-size:1rem;">공지 및 가이드</h3>
            <div
                style="background:var(--card-bg); border-radius:20px; padding:1rem; border:1px solid rgba(255,255,255,0.05); font-size: 0.85rem;">
                <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text-muted);">
                    AI 요약 기반 간편 입력 모드 도입 (v1046)
                </div>
            </div>
        </section>

        <!-- Floating Voice Button (Bottom Right) -->
        <button class="floating-voice-btn" onclick="kodaEngine.startVoiceRecord()">🎙️</button>
    </div>

    <!-- 3. Voice Entry Modal -->
    <div id="voice-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content voice-content">
            <div class="voice-anim">
                <div class="wave"></div>
                <div class="wave"></div>
                <div class="wave"></div>
            </div>
            <p id="voice-status-text" style="font-weight:700; font-size:1.1rem; margin:1.5rem 0;">듣고 있습니다...</p>
            <div id="voice-transcribed-text" class="voice-transcript">...</div>

            <div id="voice-disclaimer"
                style="background:rgba(255,100,100,0.1); padding:10px; border-radius:10px; border:1px solid rgba(255,100,100,0.3); color:#ff6b6b; font-size:0.75rem; text-align:left; margin-bottom:15px; margin-top:20px;">
                <strong>⚠️ 주의:</strong> AI가 알려준 합계에서 식대, 사적 모임, 의상비 등 업무 무관 지출은 본인이 직접 뺀 최종 금액으로 말해주세요. 세무상 책임은 본인에게
                있습니다.
            </div>

            <div id="voice-result-box" style="display:none; width:100%;">
                <button class="btn-primary" onclick="kodaEngine.confirmVoiceEntry()"
                    style="width:100%; padding:1.2rem;">기록 확정</button>
            </div>
            <button class="modal-close" onclick="kodaEngine.cancelVoiceModal()">✕</button>
        </div>
    </div>

    <!-- 4. Payment Modal -->
    <div id="payment-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content" style="max-width:400px; padding:2rem;">
            <div id="payment-view-initial">
                <h3 style="font-size:1.3rem; margin-bottom:1rem;">프리미엄 멤버십</h3>
                <p style="color:var(--text-muted); margin-bottom:2rem; line-height:1.6;">
                    • 1년 치 장부 AI 자동 생성<br>
                    • 종소세 신고용 리포트 제공<br>
                    • 모든 기기 데이터 동기화
                </p>
                <button onclick="kodaEngine.requestKakaoPay()" class="btn-primary"
                    style="width:100%; padding:1.2rem; background:#FFEB00; color:#3C1E1E; border:none;">카카오페이로 5,900원
                    결제</button>
            </div>
            <div id="payment-view-success" style="display:none; text-align:center;">
                <h3 style="color:var(--primary); margin-bottom:1rem;">결제 완료!</h3>
                <p style="margin-bottom:2rem;">가입을 위해 아이디와 비번을 설정해주세요.</p>
                <form onsubmit="kodaEngine.finalizeSignUp(event)"
                    style="display:flex; flex-direction:column; gap:1rem;">
                    <input type="text" id="reg-id" placeholder="사용할 아이디" required>
                    <input type="password" id="reg-pw" placeholder="사용할 비밀번호" required>
                    <button type="submit" id="reg-submit-btn" class="btn-primary">계정 생성 및 앱 시작하기</button>
                </form>
            </div>
            <div id="payment-view-final-success" style="display:none; text-align:center;">
                <h3 style="color:var(--primary); margin-bottom:1.5rem;">🎉 환영합니다!</h3>
                <p style="margin-bottom:2rem;">이제 코다 AI 장부를 이용하실 수 있습니다.</p>
                <button onclick="location.reload()" class="btn-primary" style="width:100%;">대시보드로 이동</button>
            </div>
            <button class="modal-close" onclick="get('payment-modal').style.display='none'">✕</button>
        </div>
    </div>

    <!-- 5. Report Modal -->
    <div id="report-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content" style="max-width:500px; width:90%; padding:2rem;">
            <h2 id="report-title" style="margin-bottom:1.5rem; font-size:1.25rem;">세분화 분석 리포트</h2>
            <div id="report-content" style="max-height: 60vh; overflow-y: auto; margin-bottom: 1.5rem;">
                <!-- Dynamically populated -->
            </div>
            <button class="btn-primary" onclick="kodaEngine.closeReportModal()" style="width:100%;">확인</button>
            <button class="modal-close" onclick="kodaEngine.closeReportModal()">✕</button>
        </div>
    </div>

    <!-- 9. Bulk Entry Modal (v1046) -->
    <div id="bulk-modal" class="modal-overlay"
        style="display:none; z-index: 999999 !important; position:fixed; inset:0; background:rgba(0,0,0,0.85); align-items:center; justify-content:center;">
        <div class="modal-content" style="max-width:600px; width:95%; max-height: 90vh; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="font-size:1.1rem; font-weight:900;">AI 요약 가이드 (v1046)</h3>
                <span class="close-modal" id="close-bulk-modal" style="cursor:pointer;">&times;</span>
            </div>

            <!-- [v1046] Category Summary Guide Area -->
            <div id="bulk-input-area" style="text-align: center;">
                <div style="background:rgba(59,130,246,0.1); padding:20px; border-radius:16px; margin-bottom:20px;">
                    <h3 style="margin-top:0; color:var(--primary); font-size:1rem;">🤖 AI 요약 가이드 (전년도 실적용)</h3>
                    <p
                        style="font-size:0.85rem; color:var(--text-muted); line-height:1.6; text-align:left; margin-bottom:20px;">
                        1. 아래 버튼을 눌러 <b>AI(ChatGPT, Gemini)용 프롬프트</b>를 복사하세요.<br>
                        2. 카드/은행 앱의 1년 치 결제 내역을 AI에게 주고 요약을 시키세요.<br>
                        3. AI가 알려준 <b>항목별 합계(예: 광고비 22번 500만원)</b>를 확인하세요.<br>
                        4. 확인된 합계를 아래 <b>음성 마이크</b>를 눌러 말씀하시면 됩니다.
                    </p>

                    <button onclick="kodaEngine.copyGeminiPrompt()" class="btn-primary"
                        style="width:100%; padding:15px; font-weight:700; border-radius:12px; margin-bottom:15px; background:var(--primary); color:white; border:none; cursor:pointer;">
                        📋 AI 요약용 프롬프트 복사하기
                    </button>

                    <div
                        style="background:rgba(255,100,100,0.1); padding:12px; border-radius:10px; border:1px solid rgba(255,100,100,0.3); color:#ff6b6b; font-size:0.75rem; text-align:left;">
                        <strong>⚠️ 주의:</strong> AI가 요약한 금액 중 식대, 사적 모임, 의상비 등 업무 무관 지출은 본인이 직접 뺀 <b>최종 업무용 금액</b>으로
                        말씀해주세요. 세무상 책임은 본인에게 있습니다.
                    </div>
                </div>

                <div style="padding:20px; border:2px dashed rgba(59,130,246,0.3); border-radius:20px;">
                    <p style="margin-bottom:15px; font-weight:600;">합계 금액을 말씀하세요</p>
                    <button onclick="kodaEngine.startVoiceRecord()"
                        style="width:70px; height:70px; border-radius:50%; background:var(--primary); border:none; color:white; font-size:1.8rem; cursor:pointer; box-shadow:0 10px 20px rgba(59,130,246,0.4);">🎙️</button>
                    <p style="margin-top:15px; font-size:0.8rem; color:var(--text-muted);">"광고비 22번, 542만원" 이라고 말씀해 보세요.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast UI -->
    <div id="app-toast"></div>

    <script type="module" src="index_v1046.js?v=1046"></script>
    <div style="margin-top:25px; text-align:center; opacity:0.3; font-size:10px; cursor:pointer; padding-bottom:50px;"
        onclick="location.reload(true)">시스템 강제 새로고침 (v1046)</div>
</body>

</html>